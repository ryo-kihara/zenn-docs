---
title: "Nextãƒ»Supabase Edge Functionsãƒ»FCM ã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ””"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "Supabase", "FCM", "ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥"]
published: false
---

# ã¯ã˜ã‚ã«

ç¾åœ¨ã€ã€ŒRecoputã€ã¨ã„ã† Qiita ã‚„ Zenn ã®è¨˜äº‹ã‚’è‡ªåˆ†ã®å—œå¥½ã«å¿œã˜ã¦ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚
æœ€è¿‘ã¯ Next Ã— Supabase ã®æ§‹æˆã§ Web ã‚¢ãƒ—ãƒªã®é–‹ç™ºã‚’ã™ã‚‹ã®ãŒæµè¡Œã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ãŒã€è‡ªåˆ†ãŸã¡ã‚‚ã“ã®æ§‹æˆã§é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ Next Ã— Supabase ã®æ§‹æˆã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªé€šçŸ¥ãŒ Web ä¸Šã§é€šçŸ¥ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®å®Ÿè£…](/images/5f89b6ce16aa15/push-notification.png)

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

å…·ä½“çš„ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¯ä»¥ä¸‹ã§ã™ã€‚

- **Firebase Cloud Messaging (FCM)**: ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®é…ä¿¡
- **Supabase DB**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®FCMãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ç”¨DB
- **Supabase Edge Functions**: é€šçŸ¥é€ä¿¡å‡¦ç†ã‚’è¡Œã†é–¢æ•°
- **Next.js**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **Service Worker**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥ã®å‡¦ç†
- **Cloudflare**: ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°

Supabase å…¬å¼ã«ã‚‚ã‚¬ã‚¤ãƒ‰ãŒã‚ã‚‹ã®ã§ã€å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://supabase.com/docs/guides/functions/examples/push-notifications?queryGroups=platform&platform=fcm

ã¡ãªã¿ã« FCM ã¯ Firebase ãŒæä¾›ã—ã¦ã„ã‚‹ã€ŒFirebase Cloud Messagingã€ã®é ­æ–‡å­—ã‚’ã¨ã£ãŸé€šçŸ¥ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
â†‘ã® Supabase ã®ã‚¬ã‚¤ãƒ‰é€šã‚Šã«é€²ã‚ã‚Œã° FCM ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚‚å®Œäº†ã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€å¿µã®ç‚ºãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¼‰ã›ã¦ãŠãã¾ã™ã€‚

https://firebase.google.com/docs/cloud-messaging?hl=ja

## é€šçŸ¥ã®æµã‚Œ

å¤§ã¾ã‹ãªæµã‚Œã¯ä»¥ä¸‹ã§ã™ã€‚

1. ãƒ¦ãƒ¼ã‚¶ãŒã€ç”»é¢ä¸Šã§é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹ã€‚
2. é€šçŸ¥ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ FCM ã‹ã‚‰å–å¾—ã—ã¦ã€DB ã«ä¿å­˜ã™ã‚‹ã€‚
3. Supabase Edge Functions ã§ã€DB ã«ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ã€é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã€‚
4. ãƒ¦ãƒ¼ã‚¶ã«é€šçŸ¥ãŒå±Šãã€‚

## å‰æ

Firebase ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã—ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
å…ˆã«è¨˜è¼‰ã—ãŸ Supabase ã®ã‚¬ã‚¤ãƒ‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

## å®Ÿè£…

ä»Šå›ã¯ã€å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’è¼‰ã›ã¾ã™ã€‚
ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã¯é©å®œè¡Œãªã£ã¦ãã ã•ã„ã€‚

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã« FCM ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ

```sql
CREATE TABLE IF NOT EXISTS "fcm_tokens" (
  "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
  "user_id" uuid NOT NULL,
  "token" text NOT NULL,
  "device_info" jsonb,
  "created_at" timestamp with time zone DEFAULT now() NOT NULL,
  "updated_at" timestamp with time zone DEFAULT now() NOT NULL,
  CONSTRAINT "fcm_tokens_user_id_token_unique" UNIQUE("user_id","token")
);
```

ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã®FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã«é€šçŸ¥ã‚’é€ä¿¡ã§ãã¾ã™ã€‚

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ Firebase é€£æº & é€šçŸ¥è¨±å¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ

ã¾ãšã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã§ Firebase ã¨ã®é€£æºãŒã§ãã‚‹ã‚ˆã†ã«ã€`firebase.ts` ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import { initializeApp, getApps, getApp } from 'firebase/app'
import { getMessaging, getToken, onMessage } from 'firebase/messaging'
import { createClient } from '@/utils/supabase/client'

// Firebaseã®è¨­å®š
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
}

// Firebaseã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–
const app = !getApps().length ? initializeApp(firebaseConfig) : getApp()
// FCMã®VAPIDã‚­ãƒ¼
const vapidKey = process.env.NEXT_PUBLIC_FIREBASE_VAPID_KEY

const supabase = createClient()

/**
 * FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€Supabaseã«ä¿å­˜ã™ã‚‹
 * @returns FCMãƒˆãƒ¼ã‚¯ãƒ³
 */
export const getFCMToken = async (): Promise<string | null> => {
  try {
    // ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ç¢ºèª
    if (!('Notification' in window)) {
      console.error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“')
      return null
    }

    // é€šçŸ¥ã®è¨±å¯ã‚’å–å¾—
    const permission = await Notification.requestPermission()
    if (permission !== 'granted') {
      console.error('é€šçŸ¥ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ')
      return null
    }

    // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const messaging = getMessaging(app)
    const currentToken = await getToken(messaging, { vapidKey })

    if (!currentToken) {
      console.error('FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ')
      return null
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
    const {
      data: { user },
    } = await supabase.auth.getUser()

    console.log('user', user)

    if (!user) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“')
      return null
    }

    // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
    const deviceInfo = {
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
    }

    // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’Supabaseã«ä¿å­˜
    const { error } = await supabase.from('fcm_tokens').upsert(
      {
        user_id: user.id,
        token: currentToken,
        device_info: deviceInfo,
      },
      {
        onConflict: 'user_id, token',
      },
    )

    if (error) {
      console.error('FCMãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error)
      return null
    }

    return currentToken
  } catch (error) {
    console.error('FCMãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error)
    return null
  }
}

// FCMãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å‹å®šç¾©
export interface FCMMessagePayload {
  notification?: {
    title?: string
    body?: string
    image?: string
  }
  data?: Record<string, string>
  from: string
  messageId: string
  collapseKey?: string
  fcmOptions?: {
    analyticsLabel?: string
  }
}

/**
 * ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
 * @param callback ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
 */
export const onMessageListener = (
  callback: (payload: FCMMessagePayload) => void,
): (() => void) => {
  if (typeof window === 'undefined') return () => {}

  try {
    const messaging = getMessaging(app)
    const unsubscribe = onMessage(messaging, (payload) => {
      callback(payload as FCMMessagePayload)
    })

    return unsubscribe
  } catch (error) {
    console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error)
    return () => {}
  }
}

export { app }
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

- `getFCMToken`: FCM ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ã€Supabase ã«ä¿å­˜ã™ã‚‹ã€‚
- `onMessageListener`: ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã™ã‚‹ã€‚ç”»é¢ã‚’é–‹ã„ã¦ã„ã‚‹ã¨ãã«é€šçŸ¥ãŒæ¥ãŸã‚‰ã€ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã¨ã—ã¦è¡¨ç¤ºã€‚

æ¬¡ã«ã€é€šçŸ¥è¨±å¯ã®ãƒˆãƒ¼ã‚¹ãƒˆã‚’è¡¨ç¤ºã•ã›ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

![é€šçŸ¥è¨±å¯ç”»é¢](/images/5f89b6ce16aa15/notification-permission.png)

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```tsx
'use client'

import { useEffect, useState } from 'react'
import {
  getFCMToken,
  onMessageListener,
  FCMMessagePayload,
} from '@/lib/firebase'
import { toast } from 'react-hot-toast'

interface PushNotificationManagerProps {
  children: React.ReactNode
}

export const PushNotificationManager: React.FC<
  PushNotificationManagerProps
> = ({ children }) => {
  const [fcmToken, setFcmToken] = useState<string | null>(null)
  const [notificationPermission, setNotificationPermission] = useState<
    NotificationPermission | 'default' | null
  >(null)

  // é€šçŸ¥ã®è¨±å¯çŠ¶æ…‹ã‚’ç¢ºèª
  useEffect(() => {
    if (typeof window === 'undefined') return

    if ('Notification' in window) {
      setNotificationPermission(Notification.permission)
    }
  }, [])

  // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
  useEffect(() => {
    const initializeFCM = async () => {
      try {
        const token = await getFCMToken()
        if (token) {
          setFcmToken(token)
        }
      } catch {
        throw new Error()
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€šçŸ¥ã‚’è¨±å¯ã—ã¦ã„ã‚‹å ´åˆã®ã¿FCMã‚’åˆæœŸåŒ–
    if (notificationPermission === 'granted') {
      initializeFCM()
    }
  }, [notificationPermission])

  // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®é€šçŸ¥ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  useEffect(() => {
    if (typeof window === 'undefined' || !fcmToken) return

    const unsubscribe = onMessageListener((payload: FCMMessagePayload) => {
      toast(
        (t) => (
          <div
            className="flex cursor-pointer items-start gap-2"
            onClick={() => {
              // é€šçŸ¥ã®ã‚¯ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
              const url = payload.data?.url || '/'
              window.location.href = url
              toast.dismiss(t.id)
            }}
          >
            <div className="flex-1">
              <div className="font-bold">{payload.notification?.title}</div>
              <div className="text-p-s">{payload.notification?.body}</div>
            </div>
          </div>
        ),
        {
          duration: 6000,
          position: 'top-right',
        },
      )
    })

    return () => {
      unsubscribe()
    }
  }, [fcmToken])

  // é€šçŸ¥ã®è¨±å¯ã‚’è¦æ±‚ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const requestNotificationPermission = async () => {
    if (!('Notification' in window)) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“')
      return
    }

    try {
      // ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã¯ã€éåŒæœŸé–¢æ•°å†…ã§Promiseã‚’ç›´æ¥å‘¼ã³å‡ºã™ã¨ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹
      // ç›´æ¥å‘¼ã³å‡ºã—ã«å¤‰æ›´
      const permission = Notification.requestPermission()
      if (permission instanceof Promise) {
        permission.then((result) => {
          setNotificationPermission(result)

          if (result === 'granted') {
            getFCMToken().then((token) => {
              if (token) {
                setFcmToken(token)
              }
            })
          }
        })
      } else {
        // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ï¼ˆéPromiseå½¢å¼ï¼‰
        setNotificationPermission(permission)

        if (permission === 'granted') {
          const token = await getFCMToken()
          if (token) {
            setFcmToken(token)
          }
        }
      }
    } catch {
      throw new Error()
    }
  }

  return (
    <>
      {children}
      {notificationPermission === 'default' && (
        <div className="fixed bottom-4 right-4 z-overlay max-w-sm rounded-lg bg-white p-4 shadow-lg">
          <h3 className="mb-2 font-bold">é€šçŸ¥ã‚’å—ã‘å–ã‚Šã¾ã™ã‹ï¼Ÿ</h3>
          <p className="mb-4 text-p-m">
            æœ€æ–°ã®æƒ…å ±ã‚„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã§å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
          </p>
          <div className="flex justify-end gap-2">
            <button
              className="px-4 py-2 text-p-m text-gray-600"
              onClick={() => setNotificationPermission('denied')}
            >
              å¾Œã§
            </button>
            <button
              className="rounded bg-blue-600 px-4 py-2 text-p-m text-white"
              onClick={requestNotificationPermission}
            >
              è¨±å¯ã™ã‚‹
            </button>
          </div>
        </div>
      )}
    </>
  )
}
```

ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥è¨±å¯ã‚’æ±‚ã‚ã€è¨±å¯ã•ã‚ŒãŸå ´åˆã¯FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å—ä¿¡ã—ãŸé€šçŸ¥ã‚’ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹å½¹å‰²ã‚‚æ‹…ã£ã¦ã„ã¾ã™ã€‚

### 3. Service Worker ã‚’ä½œæˆ

2ã§é€šçŸ¥ãŒè¨±å¯ã•ã‚ŒãŸã‚‰ã€ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã„ã¦ã‚‚ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§é€šçŸ¥ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

Service Worker ã¯ Next.js ã®å ´åˆã€public ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«é…ç½®ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```bash
|-- public
|   |-- firebase-messaging-sw.js
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã«ç”Ÿæˆã™ã‚‹ã‚ˆã†ã« package.json ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã€Œpreã€ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆåã®å‰ã«ã¤ã‘ã‚‹ã“ã¨ã§ã€ã€Œnpm run devã€ã‚„ã€Œnpm run buildã€ã®å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```json
"predev": "node scripts/generate-sw.mjs dev",
"prebuild": "node scripts/generate-sw.mjs build"
```

`scripts/generate-sw.mjs` ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```js
#!/usr/bin/env node

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'
import dotenv from 'dotenv'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
const buildCommand = process.argv[2]
if (!buildCommand) {
  throw new Error('Command is required. (dev or build)')
}
const envFile = buildCommand === 'build' ? '.env' : '.env.local'
dotenv.config({ path: path.resolve(__dirname, `../${envFile}`) })

// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Firebaseã®è¨­å®š
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
}

// ã‚«ã‚¹ã‚¿ãƒ ã®å¤‰æ›é–¢æ•°ã‚’ä½œæˆ
const formatFirebaseConfig = (config) => {
  // Object.entriesã‚’ä½¿ç”¨ã—ã¦ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢ã‚’å–å¾—ã—ã€å‡¦ç†
  const entries = Object.entries(config)
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    .filter(([_, value]) => value !== undefined) // undefinedå€¤ã‚’é™¤å¤–
    .map(([key, value]) => {
      // æ–‡å­—åˆ—å€¤ã‚’ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã‚€
      const formattedValue = typeof value === 'string' ? `'${value}'` : value
      return `  ${key}: ${formattedValue},`
    })
    .join('\n')

  return `{\n${entries}\n}`
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ç”Ÿæˆ
const swTemplatePath = path.join(
  __dirname,
  '../public/firebase-messaging-sw.template.js',
)
const swTemplate = fs.readFileSync(swTemplatePath, 'utf8')

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®å¤‰æ•°ã‚’ç½®æ›
const swCode = swTemplate.replace(
  'FIREBASE_CONFIG_PLACEHOLDER',
  formatFirebaseConfig(firebaseConfig),
)

// ç”Ÿæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’æ›¸ãè¾¼ã¿
const swOutputPath = path.join(__dirname, '../public/firebase-messaging-sw.js')
fs.writeFileSync(swOutputPath, swCode)

console.log(
  '\n \x1b[32mâœ“ \x1b[0mFirebase Messaging Service Worker generated successfully\n',
)
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

1. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ Firebase ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€ã€‚
2. `public/firebase-messaging-sw.template.js` ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚
3. ç”Ÿæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’æ›¸ãè¾¼ã‚€ã€‚

2ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ãŸç†ç”±ã¯ã€ã“ã‚ŒãŒãªã„ã¨ç’°å¢ƒå¤‰æ•°ã‚’ç›´æ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚
ã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã†ã¨ã€é€šå¸¸ public ãƒ•ã‚©ãƒ«ãƒ€ã¯ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã«ãªã‚Šã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
èª­ã¿è¾¼ã‚ãªã„ãŸã‚ã€ç›´æ¥ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¿°ã—ãªã‘ã‚Œã°ãªã‚‰ãªããªã‚Šã€Git ç®¡ç†ãŒã§ããªããªã‚Šã¾ã™ã€‚

ã“ã®çŠ¶æ…‹ã§å…ˆã«ã‚‚è¨˜è¿°ã—ãŸä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`public/firebase-messaging-sw.js` ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ã•ã‚‰ã«ç’°å¢ƒå¤‰æ•°ãŒå±•é–‹ã•ã‚ŒãŸçŠ¶æ…‹ã«ãªã‚‹ã®ã§ã€å®‰å¿ƒã—ã¦ Git ç®¡ç†ã§ãã¾ã™ã€‚

```json
"predev": "node scripts/generate-sw.mjs dev",
"prebuild": "node scripts/generate-sw.mjs build"
```

### 4. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…

Supabase Edge Functionsã‚’ä½¿ç”¨ã—ã¦ã€é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ï¼š

```typescript
import { createClient } from 'jsr:@supabase/supabase-js@2'
import { JWT } from 'npm:google-auth-library@8.9.0'

import serviceAccount from '../_shered/env/firebase/service-account.json' with { type: 'json' }
import { addDays, getToday } from '../_shered/utils/date.ts'

// ä»Šæ—¥ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã—ãŸè¨˜äº‹ã®ãƒ¦ãƒ¼ã‚¶ã«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹Function
Deno.serve(async () => {
  try {
    // ä»Šæ—¥ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã—ãŸè¨˜äº‹ã®ãƒ¦ãƒ¼ã‚¶ã®IDã‚’å–å¾—
    const today = getToday()
    const tomorrow = addDays(today, 1)
    const { data: userArticles } = await supabase
      .from('user_articles')
      .select('user_id')
      .gte('created_at', today)
      .lt('created_at', tomorrow)

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const { data: fcmTokens } = await supabase
      .from('fcm_tokens')
      .select('token')
      .in(
        'user_id',
        userArticles.map((userArticle) => userArticle.user_id),
      )

    // JWTã‚’ä½¿ç”¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const accessToken = await getAccessToken({
      clientEmail: serviceAccount.client_email,
      privateKey: serviceAccount.private_key,
    })

    // ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«é€šçŸ¥ã‚’é€ä¿¡
    const notificationResults = await Promise.all(
      fcmTokens.map(async (fcmToken) => {
        try {
          // FCM V1 APIã‚’ä½¿ç”¨ã—ã¦é€šçŸ¥ã‚’é€ä¿¡
          const res = await fetch(
            `https://fcm.googleapis.com/v1/projects/${serviceAccount.project_id}/messages:send`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({
                message: {
                  token: fcmToken.token,
                  notification: {
                    title: 'ä»Šæ—¥ã®ãŠã™ã™ã‚è¨˜äº‹ãŒé…ä¿¡ã•ã‚Œã¾ã—ãŸã€‚',
                    body: 'è¨˜äº‹ã‚’èª­ã‚“ã§ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚',
                  },
                },
              }),
            },
          )
          // çœç•¥...
        } catch (error) {
          // ã‚¨ãƒ©ãƒ¼å‡¦ç†
        }
      }),
    )

    // çµæœã®ã‚µãƒãƒªãƒ¼ã‚’è¿”ã™
    return new Response(JSON.stringify(summary), {
      headers: { 'Content-Type': 'application/json' },
    })
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
  }
})
```

ã“ã®é–¢æ•°ã§ã€ä»Šæ—¥è¨˜äº‹ã‚’ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚
Firebase Admin SDKã‚’ä½¿ç”¨ã—ã¦FCM V1 APIã‚’å‘¼ã³å‡ºã—ã€å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒã‚¤ã‚¹ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

service-account.json ã¯ã€Firebase ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æƒ…å ±ã‚’å«ã‚€ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
ã‚¬ã‚¤ãƒ‰ã«å¾“ã£ã¦ Firebase ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã€èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚

ã‚‚ã—ã€Supabase Edge Functions ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€ã“ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å½“ç„¶ã§ã™ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸Šã§å®Ÿè£…å®Œäº†ã§ã™ã€‚

## æœ€å¾Œã«

Next Ã— Supabase ã¯ä½•ã‚’ã™ã‚‹ã«ã—ã¦ã‚‚çˆ†é€Ÿã§å®Ÿè£…ãŒã§ãã¾ã™ã­ã€‚
Service Worker ã§ç’°å¢ƒå¤‰æ•°ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã«å±•é–‹ã™ã‚‹æ–¹æ³•ã¯å·¥å¤«ã—ãŸãƒã‚¤ãƒ³ãƒˆãªã®ã§ã€ãœã²å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ãã‚Œã§ã¯ã€è‰¯ã„ Next Ã— Supabase ãƒ©ã‚¤ãƒ•ã‚’ï¼
Recoput ã®ãƒªãƒªãƒ¼ã‚¹ã‚‚ãŠæ¥½ã—ã¿ã«ã€‚
